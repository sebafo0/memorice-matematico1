<script>
const operacionesPorCurso = {
  1: [
    ["2 + 3", "5"],
    ["5 × 2", "10"],
    ["6 - 1", "5"],
    ["9 ÷ 3", "3"],
    ["4 × 4", "16"],
    ["8 - 3", "5"],
    ["7 + 2", "9"],
    ["10 ÷ 2", "5"]
  ],
  2: [
    ["3 × 6", "18"],
    ["12 ÷ 4", "3"],
    ["15 - 7", "8"],
    ["9 + 5", "14"],
    ["8 × 2", "16"],
    ["6 + 9", "15"],
    ["20 ÷ 5", "4"],
    ["18 - 3", "15"]
  ],
  3: [
    ["(3 + 5) × 2", "16"],
    ["(12 - 4) ÷ 2", "4"],
    ["9 × (2 + 1)", "27"],
    ["(18 ÷ 3) + 6", "12"],
    ["(7 × 3) - 5", "16"],
    ["5²", "25"],
    ["√36", "6"],
    ["(4 + 4) × 2", "16"]
  ],
  4: [
    ["(5 × 2)²", "100"],
    ["√81", "9"],
    ["(9 - 3) × 4", "24"],
    ["3³", "27"],
    ["(2 + 6) × (3 - 1)", "16"],
    ["49 ÷ 7", "7"],
    ["(5 × 4) + (6 ÷ 2)", "23"],
    ["√64", "8"]
  ]
};

let selectedCards = [];
let score = 0;
let highScore = localStorage.getItem("highScore") || 0;
let timer;
let tiempoRestante = 0;

const gameBoard = document.getElementById("game-board");
const cursoSelect = document.getElementById("curso");
const nivelSelect = document.getElementById("nivel");
const scoreBoard = document.getElementById("score-board");
const highScoreDiv = document.getElementById("high-score");
const explicacionDiv = document.getElementById("explicacion");
const timerDiv = document.getElementById("timer");

highScoreDiv.textContent = `Puntaje más alto: ${highScore}`;

function actualizarTimer() {
  let minutos = Math.floor(tiempoRestante / 60);
  let segundos = tiempoRestante % 60;
  timerDiv.textContent = `Tiempo: ${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
  if (tiempoRestante <= 0) {
    clearInterval(timer);
    alert("⏱️ ¡Tiempo terminado!");
  }
  tiempoRestante--;
}

function iniciarCronometro(nivel) {
  clearInterval(timer);
  if (nivel === "facil") tiempoRestante = 7 * 60;
  else if (nivel === "medio") tiempoRestante = 5 * 60;
  else tiempoRestante = 4 * 60;
  actualizarTimer();
  timer = setInterval(actualizarTimer, 1000);
}

function generarCartas() {
  gameBoard.innerHTML = "";
  explicacionDiv.textContent = "";
  selectedCards = [];
  score = 0;
  scoreBoard.textContent = `Puntaje: 0`;

  const curso = cursoSelect.value;
  const nivel = nivelSelect.value;

  iniciarCronometro(nivel);

  let operaciones = operacionesPorCurso[curso];
  operaciones = operaciones.sort(() => Math.random() - 0.5).slice(0, 7); // 7 pares = 14 cartas

  let pares = [];
  for (let [op, res] of operaciones) {
    pares.push({ tipo: "op", texto: op, resultado: res });
    pares.push({ tipo: "res", texto: res, resultado: res });
  }

  pares = pares.sort(() => Math.random() - 0.5);

  pares.forEach((carta, i) => {
    const div = document.createElement("div");
    div.classList.add("card");
    div.dataset.tipo = carta.tipo;
    div.dataset.resultado = carta.resultado;
    div.textContent = "?";
    div.dataset.textoReal = carta.texto;

    div.addEventListener("click", () => seleccionarCarta(div));
    gameBoard.appendChild(div);
  });
}

function seleccionarCarta(card) {
  if (card.classList.contains("revealed") || selectedCards.length === 2) return;

  card.textContent = card.dataset.textoReal;
  card.classList.add("revealed");
  selectedCards.push(card);

  if (selectedCards.length === 2) {
    const [c1, c2] = selectedCards;

    if (
      c1 !== c2 &&
      ((c1.dataset.tipo === "op" && c2.dataset.tipo === "res") ||
      (c1.dataset.tipo === "res" && c2.dataset.tipo === "op")) &&
      c1.dataset.resultado === c2.dataset.resultado
    ) {
      c1.classList.add("correct");
      c2.classList.add("correct");
      score++;
      scoreBoard.textContent = `Puntaje: ${score}`;

      if (score > highScore) {
        highScore = score;
        localStorage.setItem("highScore", highScore);
        highScoreDiv.textContent = `Puntaje más alto: ${highScore}`;
      }

      explicacionDiv.textContent = `✔️ ${c1.dataset.resultado} es correcto porque ${c1.dataset.tipo === 'op' ? c1.dataset.textoReal : c2.dataset.textoReal} = ${c1.dataset.resultado}`;
      selectedCards = [];
    } else {
      c1.classList.add("wrong");
      c2.classList.add("wrong");
      explicacionDiv.textContent = `❌ Intenta de nuevo.`;

      setTimeout(() => {
        c1.classList.remove("revealed", "wrong");
        c2.classList.remove("revealed", "wrong");
        c1.textContent = "?";
        c2.textContent = "?";
        selectedCards = [];
      }, 1000);
    }
  }
}

document.getElementById("reset-btn").addEventListener("click", generarCartas);
document.addEventListener("DOMContentLoaded", generarCartas);
</script>
